# 任务性能分析指南

## 🎯 功能说明

现在训练过程中会**自动记录**每个任务的:
- ⏱️ **耗时** (秒)
- 📈 **平均得分** 
- 🚀 **效率** (得分/秒)

## 📊 输出示例

在每次evaluation时,会自动打印如下统计表格:

```
======================================================================
📊 任务性能统计
======================================================================
任务                 耗时(s)         平均得分          得分/秒
----------------------------------------------------------------------
GSM8K               45.23          0.1250        0.002763
MBPP                67.89          0.3500        0.005156
Mult4               12.34          0.9200        0.074555
Boolean              8.56          0.8750        0.102218
======================================================================
```

## 🚀 快速测试

运行快速性能测试(10轮iteration):

```bash
cd /mnt/shared-storage-user/yefei/SparseFusion
bash scripts/experiments/quick_profile_test.sh
```

这将:
- 启用 GSM8K, MBPP, Mult4, Boolean 任务
- 每个任务评估 20 个样本
- 只运行 10 轮 iteration
- 自动保存日志到 `results/profile_test_YYYYMMDD_HHMMSS/`

## 📝 查看结果

1. **实时监控**: 运行时会在终端实时打印每次evaluation的任务统计

2. **日志文件**: 所有输出保存在 `results/profile_test_*/profile_test.log`
   ```bash
   grep -A 10 "📊 任务性能统计" results/profile_test_*/profile_test.log
   ```

3. **分析任务表现**:
   - **最容易得分**: 看"平均得分"列,越高越容易
   - **最快完成**: 看"耗时"列,越小越快
   - **性价比最高**: 看"得分/秒"列,越高越值得优化

## 🔧 代码修改

已修改 `natural_niches_sparsity_aware_fn.py` 中的 `create_multi_task_evaluation_fn()`:
- 每个任务评估前后都会记录时间
- 计算平均得分
- 自动打印统计表格 (仅 rank 0 打印,避免多进程重复)

## 📌 注意事项

1. **第一次运行较慢**: 包含模型加载时间
2. **后续运行稳定**: 反映真实的evaluation耗时
3. **分布式运行**: 统计表格只在 rank 0 打印一次
4. **样本数影响**: `eval_subset_size` 越大,耗时越长但统计越准确

## 🎯 如何解读结果

### 示例分析:

假设得到如下结果:
```
任务        耗时(s)    平均得分    得分/秒
GSM8K       45.23      0.1250     0.002763
MBPP        67.89      0.3500     0.005156
Mult4       12.34      0.9200     0.074555
Boolean      8.56      0.8750     0.102218
```

**解读**:
- ✅ **Boolean**: 最高效 (0.102 得分/秒),最快(8.56s),得分高(0.875)
  - **建议**: 这是最容易提升的任务,应该加大权重
  
- ✅ **Mult4**: 效率第二 (0.075 得分/秒),耗时短,得分很高(0.92)
  - **建议**: 已经表现很好,保持现有权重
  
- ⚠️ **MBPP**: 耗时最长 (67.89s),但得分不错(0.35)
  - **建议**: 可以考虑优化代码执行部分,或减少样本数
  
- ⚠️ **GSM8K**: 耗时长 (45.23s),得分较低(0.125)
  - **建议**: 模型在数学推理上还需要改进

### 权重调整建议:

根据上述分析,可以调整权重:
```bash
# 原权重
GSM8K_WEIGHT=0.50
MBPP_WEIGHT=0.25
MULT4_WEIGHT=0.15
BOOL_WEIGHT=0.10

# 调整后 (给高效任务更多权重)
GSM8K_WEIGHT=0.30  # 降低难度高的任务权重
MBPP_WEIGHT=0.20
MULT4_WEIGHT=0.25  # 增加高效任务权重
BOOL_WEIGHT=0.25   # 增加最高效任务权重
```

## 🔄 持续监控

在长时间训练中:
1. 每个iteration都会打印任务统计
2. 可以观察各任务得分的evolution趋势
3. 发现某个任务得分停滞,可以调整策略

